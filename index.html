<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Rica Chicha - ASWA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places"></script>

    <script>
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDUh_E02w4yEchGSAwoHzInDD7AluVVaSs",
            authDomain: "artifact-storage-demo.firebaseapp.com",
            projectId: "artifact-storage-demo",
            storageBucket: "artifact-storage-demo.firebasestorage.app",
            messagingSenderId: "318890758945",
            appId: "1:318890758945:web:7c364d983494e8b7db24c6"
        });
        const __app_id = 'aswa-laricachicha';
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aswa-laricachicha';

        window.db = db;
        window.appId = appId;
        window.currentUser = null;
        window.query = query;
        window.collection = collection;
        window.where = where;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;

        const initAuth = async () => {
            try { await signInAnonymously(auth); } catch (e) { console.warn(e); }
        };
        onAuthStateChanged(auth, (user) => { window.currentUser = user; });
        initAuth();

        window.saveOrder = async (data) => {
            if (!window.currentUser) return null;
            try {
                const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pedidos'), {
                    ...data, fecha: serverTimestamp(), uid: window.currentUser.uid, 
                    compartido: false, estado: 'Pendiente', confirmado_cliente: false
                });
                return ref.id;
            } catch (e) { console.error(e); return null; }
        };

        window.marcarComoCompartido = async (id) => {
            if (!id) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', id), { compartido: true });
            } catch (e) { console.warn(e); }
        };

        window.confirmarRecibo = async (id) => {
            if (!id) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', id), { confirmado_cliente: true });
            } catch (e) { console.warn(e); }
        };

        window.obtenerEstadisticasAdmin = (callback) => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'pedidos'));
            return onSnapshot(q, (snapshot) => {
                const pedidos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const stats = {
                    total: pedidos.length,
                    hoy: pedidos.filter(p => {
                        const fecha = p.fecha?.toDate();
                        if (!fecha) return false;
                        const hoy = new Date();
                        return fecha.toDateString() === hoy.toDateString();
                    }).length,
                    compartidos: pedidos.filter(p => p.compartido).length,
                    ingresos: pedidos.reduce((sum, p) => sum + (p.total || 0), 0)
                };
                callback(stats, pedidos);
            });
        };
    </script>

    <style>
        :root { --yellow: #facc15; }
        body { font-family: 'Poppins', sans-serif; background:#0a0a0b; color:white; -webkit-tap-highlight-color:transparent; }
        .font-bebas { font-family: 'Bebas Neue', cursive; }
        .logo-container { width:90px; height:90px; background:#000; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 30px rgba(250,204,21,0.4); border:3px solid var(--yellow); cursor:pointer; overflow:hidden; }
        .logo-container img { width:100%; height:100%; object-fit:contain; }
        .app-card { background:#121214; border:1px solid #27272a; border-radius:2rem; }
        .input-dark { background:#121214; border:1px solid #27272a; color:white; border-radius:1rem; padding:1rem; width:100%; transition:0.3s; }
        .input-dark:focus { border-color:var(--yellow); outline:none; }
        .product-img { width:60px; height:60px; object-fit:contain; }
        .payment-option { border:2px solid #27272a; border-radius:1.2rem; cursor:pointer; transition:0.2s; padding:1rem; }
        .payment-option.active { border-color:var(--yellow); background:rgba(250,204,21,0.1); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(10px); }
        .toast { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:var(--yellow); color:black; padding:10px 24px; border-radius:30px; font-weight:bold; display:none; z-index:4000; font-size:12px; box-shadow:0 4px 20px rgba(250,204,21,0.5); }
        .btn-primary { background:var(--yellow); color:black; font-weight:900; border-radius:1.5rem; transition:0.2s; }
        .btn-primary:disabled { opacity:0.3; cursor:not-allowed; }
        .step-inactive { opacity:0.5; pointer-events:none; }
    </style>
</head>
<body class="pb-40">

    <div id="toast" class="toast">✓ Copiado</div>

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full bg-black/80 backdrop-blur-md z-50 border-b border-zinc-900 p-4">
        <div class="max-w-md mx-auto flex items-center gap-4">
            <div class="logo-container" id="logoAdmin">
                <img src="logo de aswa.jpg" alt="ASWA" onerror="this.style.display='none'">
            </div>
            <div>
                <h1 class="font-bebas text-4xl text-yellow-400 tracking-widest leading-none">La Rica Chicha</h1>
                <p class="text-[9px] text-yellow-300/60 font-bold uppercase tracking-[0.3em]">el oro líquido de la selva</p>
            </div>
        </div>
    </header>

    <div class="h-32"></div>

    <main class="max-w-md mx-auto px-6 space-y-8">
        
        <!-- Bienvenida Loyalty -->
        <div id="loyaltyArea" class="hidden">
            <div class="bg-yellow-500/10 border border-yellow-500/50 p-4 rounded-[1.5rem] text-center">
                <p id="loyaltyText" class="text-yellow-400 font-bold text-sm"></p>
            </div>
        </div>

        <!-- Presentaciones -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                Elige tu presentación
            </h2>
            <div class="space-y-3">
                <div class="app-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="aswa de 2 litros 1.png" class="product-img" onerror="this.style.display='none'">
                        <div>
                            <p class="font-bold text-sm">Presentación de 2 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 9.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/40 p-2 rounded-2xl">
                        <button onclick="updateQty('p2l',-1)" class="w-8 h-8 font-bold text-zinc-500">-</button>
                        <span id="qty-p2l" class="font-bold text-xl w-6 text-center">0</span>
                        <button onclick="updateQty('p2l',1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>

                <div class="app-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="aswa de 3 litros.png" class="product-img" onerror="this.style.display='none'">
                        <div>
                            <p class="font-bold text-sm">Presentación de 3 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 13.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/40 p-2 rounded-2xl">
                        <button onclick="updateQty('p3l',-1)" class="w-8 h-8 font-bold text-zinc-500">-</button>
                        <span id="qty-p3l" class="font-bold text-xl w-6 text-center">0</span>
                        <button onclick="updateQty('p3l',1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>

                <div class="app-card p-4 flex items-center justify-between border-yellow-500/20">
                    <div class="flex items-center gap-3">
                        <img src="galon familiar de 4 litros.png" class="product-img" onerror="this.style.display='none'">
                        <div>
                            <p class="font-bold text-sm">Presentación de 4 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 15.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/40 p-2 rounded-2xl">
                        <button onclick="updateQty('p4l',-1)" class="w-8 h-8 font-bold text-zinc-500">-</button>
                        <span id="qty-p4l" class="font-bold text-xl w-6 text-center">0</span>
                        <button onclick="updateQty('p4l',1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Datos de Entrega -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                Datos de entrega
            </h2>
            <div class="space-y-3">
                <input type="tel" id="telefono" placeholder="Celular (9 dígitos)" maxlength="9" class="input-dark font-bold text-yellow-400">
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-dark">
                <select id="distrito" onchange="calculate()" class="input-dark">
                    <option value="" disabled selected>Zona de reparto...</option>
                    <option value="3">Morales (S/3)</option>
                    <option value="4">Tarapoto (S/4)</option>
                    <option value="5">Banda de Shilcayo (S/5)</option>
                    <option value="0">Recojo en local (S/0)</option>
                </select>
                <input type="text" id="direccion" placeholder="Dirección completa (con autocomplete)" class="input-dark">
                <button onclick="getGPS()" id="gpsBtn" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 font-bold text-xs flex gap-2 justify-center items-center">
                    <i data-lucide="map-pin" class="w-4 h-4"></i> COMPARTIR MI UBICACIÓN GPS
                </button>
            </div>
        </section>

        <!-- Método de Pago -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                Método de pago
            </h2>
            <div class="grid grid-cols-3 gap-3">
                <div onclick="setPay('Efectivo')" id="m-Efectivo" class="payment-option active flex flex-col items-center gap-2">
                    <i data-lucide="banknote" class="w-8 h-8 text-green-500"></i>
                    <span class="text-xs font-bold">Efectivo</span>
                </div>
                <div onclick="setPay('Yape')" id="m-Yape" class="payment-option flex flex-col items-center gap-2">
                    <div class="w-8 h-8 bg-purple-600 rounded flex items-center justify-center text-white text-lg font-black">Y</div>
                    <span class="text-xs font-bold">Yape</span>
                </div>
                <div onclick="setPay('Plin')" id="m-Plin" class="payment-option flex flex-col items-center gap-2">
                    <div class="w-8 h-8 bg-cyan-500 rounded flex items-center justify-center text-white text-lg font-black">P</div>
                    <span class="text-xs font-bold">Plin</span>
                </div>
            </div>

            <!-- Calculadora Vuelto -->
            <div id="vueltoArea" class="p-4 app-card">
                <p class="text-xs font-bold text-zinc-500 mb-2 uppercase">Calculadora de Vuelto</p>
                <input type="number" id="pagoCon" placeholder="¿Con cuánto pagarás?" oninput="calcVuelto()" class="input-dark mb-2">
                <p id="vueltoMsg" class="text-yellow-500 font-black text-sm">Vuelto: S/ 0.00</p>
            </div>
        </section>

        <!-- Redes y Local -->
        <div class="text-center py-10 space-y-6 opacity-70">
            <p class="text-[9px] font-black uppercase tracking-[0.4em] text-zinc-500">El sabor que une a nuestra familia también está</p>
            <a href="https://www.google.com/maps/search/?api=1&query=ASWA+Tarapoto" target="_blank"
               class="flex items-center gap-3 px-6 py-4 rounded-2xl bg-zinc-900/70 border border-zinc-800 w-full max-w-xs mx-auto">
                <i data-lucide="map-pin" class="text-yellow-500 w-6 h-6"></i>
                <div class="text-left">
                    <p class="text-[9px] text-zinc-500 font-bold uppercase tracking-wider">Visítanos en local</p>
                    <p class="text-sm font-bold text-white">Ver en Google Maps</p>
                </div>
                <i data-lucide="external-link" class="text-zinc-500 w-4 h-4 ml-auto"></i>
            </a>
            <div class="flex justify-center gap-8 pt-4">
                <a href="https://facebook.com/aswa.laricachicha" target="_blank" class="text-zinc-600 hover:text-blue-500 transition">
                    <i data-lucide="facebook" class="w-6 h-6"></i>
                </a>
                <a href="https://instagram.com/aswa.laricachicha" target="_blank" class="text-zinc-600 hover:text-pink-500 transition">
                    <i data-lucide="instagram" class="w-6 h-6"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Footer Fijo -->
    <footer class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-xl border-t border-zinc-800 p-6 z-[100]">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div>
                <p id="labelNormal" class="text-xs text-zinc-600 line-through hidden"></p>
                <p id="descuentoInfo" class="text-[9px] text-green-400 font-bold hidden"></p>
                <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">Total a pagar</p>
                <p id="totalDisplay" class="text-4xl font-bebas text-yellow-500 tracking-wider">S/ 0.00</p>
            </div>
            <button onclick="openSummary()" class="btn-primary px-10 h-14 flex items-center gap-2 text-lg">
                CONTINUAR <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </footer>

    <!-- Modal Resumen -->
    <div id="modalSummary" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-zinc-800 overflow-y-auto max-h-[90vh]">
            <h3 class="font-bebas text-3xl text-yellow-500 text-center mb-6">RESUMEN DEL PEDIDO</h3>
            <div id="sumList" class="space-y-2 text-sm text-zinc-300 mb-6 border-b border-zinc-800 pb-4"></div>
            
            <!-- Zona Digital -->
            <div id="digitalArea" class="hidden space-y-5 text-center">
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800">
                    <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Pago a: Telma Pezo Meléndez</p>
                    <button onclick="copyNumber()" class="text-xl font-black text-yellow-500 flex items-center justify-center gap-2 mx-auto">
                        947 999 736 <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
                <img src="yape del negocio.jpg" class="w-48 mx-auto rounded-3xl border-4 border-white shadow-2xl" onerror="this.style.display='none'">
                <button onclick="confirmDigital()" id="btnConfirmPay" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 text-xs font-black border border-yellow-500/20">
                    ¡YA REALICÉ EL PAGO!
                </button>
            </div>

            <!-- Info Efectivo -->
            <div id="cashArea" class="hidden text-center py-6">
                <i data-lucide="truck" class="w-16 h-16 text-zinc-500 mx-auto mb-4"></i>
                <p class="text-zinc-300">Pagarás en efectivo al recibir</p>
            </div>

            <button id="btnFinal" onclick="submitOrder()" disabled class="btn-primary w-full h-14 mt-6 flex justify-center gap-2 items-center text-lg">
                ENVIAR PEDIDO <i data-lucide="send" class="w-5 h-5"></i>
            </button>
            
            <button onclick="closeModal()" class="w-full mt-6 text-zinc-600 text-xs font-bold uppercase tracking-widest">Volver</button>
        </div>
    </div>

    <!-- Pantalla de Éxito y Tracking -->
    <div id="successScreen" class="hidden fixed inset-0 bg-black z-[3000] flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
        <div class="w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-xl shadow-yellow-500/30">
            <i data-lucide="check" class="text-black w-12 h-12"></i>
        </div>
        
        <h2 class="font-bebas text-5xl text-yellow-500 mb-2 tracking-wider">¡PEDIDO ENVIADO!</h2>
        <p id="statusMsg" class="text-zinc-400 text-sm mb-2">Tu pedido llegó a ASWA</p>
        <p id="successDetail" class="text-zinc-500 text-xs mb-8">Pronto te contactaremos</p>

        <!-- Badge Descuento -->
        <div id="discountBadge" class="hidden mb-8">
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-5 rounded-3xl shadow-2xl">
                <p id="discountText" class="text-3xl font-bebas text-white"></p>
                <p id="discountReason" class="text-sm mt-2 text-white/90"></p>
            </div>
        </div>

        <!-- Confirmación Cliente (cuando admin marque Entregado) -->
        <div id="clientConfirmArea" class="hidden w-full max-w-sm space-y-4 mb-8">
            <div class="bg-green-600/20 border-2 border-green-500 p-4 rounded-2xl">
                <p class="text-green-400 font-bold mb-3">¿Ya recibiste tu pedido?</p>
                <button onclick="finalConfirmation()" class="w-full py-4 bg-green-600 text-white rounded-2xl font-black shadow-lg">
                    SÍ, YA RECIBÍ MI ASWA ✅
                </button>
            </div>
        </div>

        <!-- Descarga PDF -->
        <div id="receiptArea" class="hidden w-full max-w-sm mb-8">
            <button onclick="downloadNota()" class="w-full py-5 bg-white text-black rounded-2xl font-black flex justify-center items-center gap-2 shadow-xl">
                <i data-lucide="download" class="w-5 h-5"></i>
                DESCARGAR NOTA DE VENTA PDF
            </button>
        </div>

        <!-- Compartir en Redes -->
        <div class="w-full max-w-sm space-y-6 mb-10">
            <p class="text-zinc-300 text-sm">¡Comparte tu pedido y etiqueta a ASWA!</p>
            <div class="flex justify-center gap-8">
                <button onclick="compartirEnFacebook()" class="bg-[#1877F2] p-5 rounded-3xl shadow-2xl transition hover:scale-110">
                    <i data-lucide="facebook" class="w-10 h-10 text-white"></i>
                </button>
                <button onclick="compartirEnInstagram()" class="bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 p-5 rounded-3xl shadow-2xl transition hover:scale-110">
                    <i data-lucide="instagram" class="w-10 h-10 text-white"></i>
                </button>
            </div>
            <button id="btnConfirmarCompartido" onclick="confirmarCompartidoEnRedes()" class="mt-6 w-full py-4 bg-green-600/20 text-green-400 border border-green-400/40 rounded-2xl font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                ¡SÍ, YA COMPARTÍ EN REDES!
            </button>
        </div>

        <button onclick="location.reload()" class="bg-yellow-500 text-black px-12 py-5 rounded-3xl text-xl font-black shadow-2xl flex items-center gap-2">
            HACER OTRO PEDIDO <i data-lucide="refresh-cw" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/98 z-[3500] overflow-y-auto p-6">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="font-bebas text-4xl text-yellow-400">PANEL ADMIN</h2>
                <button onclick="cerrarAdmin()" class="text-zinc-500 text-3xl font-bold">✕</button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-800">
                    <p class="text-zinc-500 text-xs uppercase mb-2">Total Pedidos</p>
                    <p class="text-3xl font-bebas text-yellow-400" id="
