<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASWA - La Rica Chicha (Oficial)</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Pay & Maps API -->
    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&libraries=places"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'aswa-laricachicha';

        window.db = db; window.appId = appId;
        signInAnonymously(auth);

        window.saveOrder = async (data) => {
            const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pedidos'), {
                ...data, fecha: serverTimestamp(), estado: 'Pendiente', confirmado_cliente: false, compartido: false
            });
            return ref.id;
        };
    </script>

    <style>
        :root { --yellow: #facc15; }
        body { font-family: 'Poppins', sans-serif; background:#0a0a0b; color:white; overflow-x: hidden; }
        .font-bebas { font-family: 'Bebas Neue', cursive; }
        .logo-container { width:90px; height:90px; background:#000; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 30px rgba(250,204,21,0.4); border:3px solid var(--yellow); overflow:hidden; cursor:pointer; }
        .app-card { background: #121214; border: 1px solid #27272a; border-radius: 2rem; }
        .input-dark { background:#121214; border:1px solid #27272a; color:white; border-radius: 1rem; padding: 1rem; width: 100%; }
        .input-dark:focus { border-color: var(--yellow); outline: none; }
        .btn-order { background: var(--yellow); color: black; font-weight: 900; border-radius: 1.5rem; transition: 0.2s; height: 3.5rem; width: 100%; }
        .payment-option { border: 2px solid #27272a; border-radius: 1.2rem; cursor: pointer; transition: 0.2s; }
        .payment-option.active { border-color: var(--yellow); background: rgba(250,204,21,0.1); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(10px); }
        .pac-container { background: #121214; border: 1px solid #333; color: white; border-radius: 1rem; }
    </style>
</head>
<body class="pb-40">

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full bg-black/80 backdrop-blur-md z-50 border-b border-zinc-900 p-4">
        <div class="max-w-md mx-auto flex items-center gap-4">
            <div class="logo-container" onclick="adminAccess()">
                <img src="logo de aswa.jpg" alt="ASWA">
            </div>
            <div>
                <h1 class="font-bebas text-4xl text-yellow-400 tracking-widest leading-none">La Rica Chicha</h1>
                <p class="text-[9px] text-yellow-300/60 font-bold uppercase tracking-widest">el oro l√≠quido de la selva</p>
            </div>
        </div>
    </header>

    <div class="h-36"></div>

    <main class="max-w-md mx-auto px-6 space-y-8">
        <!-- Fidelidad -->
        <div id="welcomeMsg" class="hidden">
            <div class="bg-yellow-500/10 border border-yellow-500/50 p-4 rounded-3xl text-center text-yellow-400 text-sm font-bold animate-pulse">
                <span id="welcomeTxt"></span>
            </div>
        </div>

        <!-- Productos -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex gap-2"><span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> Elige tus packs</h2>
            <div id="pack-list" class="space-y-3">
                <!-- Se repite para 2L, 3L y 4L -->
                <div class="app-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="aswa de 2 litros 1.png" class="w-16 h-16 object-contain">
                        <div><p class="font-bold text-sm">Pack 2L</p><p class="text-yellow-400 font-bebas text-2xl">S/ 9.00</p></div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/40 p-2 rounded-2xl">
                        <button onclick="changeQty('p2l', -1)" class="w-8 h-8 font-bold">-</button>
                        <span id="qty-p2l" class="font-bold text-xl w-4 text-center">0</span>
                        <button onclick="changeQty('p2l', 1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>
                <!-- ...otros packs... -->
            </div>
        </section>

        <!-- Entrega con Google Places -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex gap-2"><span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> Entrega</h2>
            <div class="space-y-3">
                <input type="tel" id="tel" placeholder="Celular" maxlength="9" class="input-dark font-bold text-yellow-400">
                <input type="text" id="nom" placeholder="Tu nombre" class="input-dark">
                <select id="zon" onchange="calculate()" class="input-dark">
                    <option value="" disabled selected>Zona de reparto...</option>
                    <option value="3">Morales (S/3)</option>
                    <option value="4">Tarapoto (S/4)</option>
                    <option value="5">Banda de Shilcayo (S/5)</option>
                    <option value="0">Recojo en local (S/0)</option>
                </select>
                <input type="text" id="dir" placeholder="Direcci√≥n exacta (Maps)" class="input-dark">
                <button onclick="getGPS()" id="gpsBtn" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 font-bold text-xs flex gap-2 justify-center">
                    <i data-lucide="map-pin"></i> COMPARTIR GPS ACTUAL
                </button>
            </div>
        </section>

        <!-- Pago Din√°mico -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex gap-2"><span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> Pago</h2>
            <div class="grid grid-cols-3 gap-2">
                <div onclick="setPay('Efectivo')" id="m-Efectivo" class="payment-option active p-3 flex flex-col items-center gap-1">
                    <i data-lucide="banknote" class="text-green-500"></i><span class="text-[9px] font-bold">Efectivo</span>
                </div>
                <div onclick="setPay('Yape')" id="m-Yape" class="payment-option p-3 flex flex-col items-center gap-1">
                    <div class="w-5 h-5 bg-purple-600 rounded flex items-center justify-center text-[9px] font-black italic">Y</div><span class="text-[9px] font-bold">Yape</span>
                </div>
                <div onclick="setPay('Digital')" id="m-Digital" class="payment-option p-3 flex flex-col items-center gap-1">
                    <i data-lucide="credit-card" class="text-blue-500"></i><span class="text-[9px] font-bold">Tarjeta/Pay</span>
                </div>
            </div>

            <!-- Calculadora Vuelto -->
            <div id="vueltoArea" class="p-4 app-card">
                <p class="text-[10px] font-bold text-zinc-500 mb-2 uppercase">Vuelto</p>
                <input type="number" id="pagoCon" placeholder="¬øCon cu√°nto pagas?" oninput="calcVuelto()" class="input-dark mb-2">
                <p id="vueltoMsg" class="text-yellow-500 font-black">Vuelto: S/ 0.00</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-xl border-t border-zinc-800 p-6 z-[100]">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div>
                <p id="totalDisplay" class="text-4xl font-bebas text-yellow-500 tracking-wider">S/ 0.00</p>
                <p id="discMotivo" class="text-green-500 text-[10px] font-bold"></p>
            </div>
            <button onclick="showSummary()" class="btn-order px-8">CONTINUAR <i data-lucide="arrow-right" class="inline"></i></button>
        </div>
    </footer>

    <!-- Modal Resumen & PDF -->
    <div id="modalSummary" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-zinc-800 overflow-y-auto max-h-[90vh]">
            <h3 class="font-bebas text-3xl text-yellow-500 text-center mb-6">RESUMEN</h3>
            <div id="sumList" class="space-y-2 text-sm text-zinc-400 mb-6"></div>
            
            <div id="payDigitalArea" class="hidden space-y-4">
                <button id="google-pay-button" class="w-full"></button>
                <div class="border-t border-zinc-800 pt-4">
                    <p class="text-[10px] text-zinc-500 text-center mb-2">O Yape/Plin a Telma Pezo</p>
                    <button onclick="copyNum()" class="w-full py-3 bg-zinc-800 rounded-xl text-yellow-500 font-bold">947 999 736 <i data-lucide="copy" class="inline w-3 h-3"></i></button>
                </div>
            </div>

            <button id="btnSend" onclick="submit()" class="btn-order mt-6">ENVIAR PEDIDO</button>
            <button onclick="closeModal()" class="w-full mt-4 text-zinc-600 text-[10px] font-bold uppercase">Cerrar</button>
        </div>
    </div>

    <!-- √âxito & Tracking -->
    <div id="success" class="hidden fixed inset-0 bg-black z-[3000] flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 bg-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce"><i data-lucide="truck" class="text-black"></i></div>
        <h2 class="font-bebas text-5xl text-yellow-500 mb-2">ASWA EN CAMINO</h2>
        <p id="statusMsg" class="text-zinc-500 text-sm mb-10">Estamos preparando tu pedido...</p>
        
        <div id="confirmArea" class="hidden w-full space-y-4 mb-8">
            <button onclick="confirmReceived()" class="w-full py-4 bg-green-600 text-white rounded-2xl font-black">¬°YA LO RECIB√ç! ‚úÖ</button>
        </div>

        <div id="pdfArea" class="hidden w-full mb-8">
            <button onclick="genPDF()" class="w-full py-4 bg-white text-black rounded-2xl font-black flex justify-center gap-2"><i data-lucide="file-text"></i> DESCARGAR NOTA DE VENTA</button>
        </div>

        <div class="flex gap-6">
            <a href="https://facebook.com/aswa.laricachicha" target="_blank" class="p-3 bg-zinc-900 rounded-xl"><i data-lucide="facebook"></i></a>
            <a href="https://instagram.com/aswa.laricachicha" target="_blank" class="p-3 bg-zinc-900 rounded-xl"><i data-lucide="instagram"></i></a>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let state = { cart:{p2l:0, p3l:0, p4l:0}, pay:'Efectivo', disc:{p:0, m:''}, gps:'', id:'' };

        // Autocomplete de Google
        window.initMap = () => {
            const autocomplete = new google.maps.places.Autocomplete(document.getElementById('dir'));
            autocomplete.setComponentRestrictions({'country': ['pe']});
        };

        function changeQty(id, d) {
            state.cart[id] = Math.max(0, state.cart[id] + d);
            document.getElementById(`qty-${id}`).innerText = state.cart[id];
            calculate();
        }

        function setPay(m) {
            state.pay = m;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`m-${m}`).classList.add('active');
            document.getElementById('vueltoArea').style.display = (m === 'Efectivo') ? 'block' : 'none';
        }

        function calculate() {
            const base = (state.cart.p2l*9) + (state.cart.p3l*13) + (state.cart.p4l*15);
            const deli = parseFloat(document.getElementById('zon').value) || 0;
            const final = (base + deli) * (1 - state.disc.p);
            document.getElementById('totalDisplay').innerText = `S/ ${final.toFixed(2)}`;
            return final;
        }

        async function submit() {
            const data = {
                nombre: document.getElementById('nom').value,
                telefono: document.getElementById('tel').value,
                direccion: document.getElementById('dir').value,
                distrito: document.getElementById('zon').options[document.getElementById('zon').selectedIndex].text,
                total: calculate(), pago: state.pay, items: state.cart
            };
            state.id = await window.saveOrder(data);
            
            // Env√≠o Dual WhatsApp
            const msg = `üåΩ *PEDIDO ASWA*\nüë§ *Cliente:* ${data.nombre}\nüìç *Zona:* ${data.distrito}\nüè† *Dir:* ${data.direccion}\nüí∞ *Total:* S/ ${data.total.toFixed(2)}`;
            window.open(`https://wa.me/51986445531?text=${encodeURIComponent(msg)}`, '_blank');
            setTimeout(() => window.open(`https://wa.me/51955273229?text=${encodeURIComponent(msg)}`, '_blank'), 1000);

            document.getElementById('modalSummary').style.display = 'none';
            document.getElementById('success').classList.remove('hidden');
            trackOrder();
        }

        function trackOrder() {
            window.onSnapshot(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'pedidos', state.id), (d) => {
                const order = d.data();
                document.getElementById('statusMsg').innerText = `Estado: ${order.estado}`;
                if(order.estado === 'Entregado') document.getElementById('confirmArea').classList.remove('hidden');
                if(order.confirmado_cliente) document.getElementById('pdfArea').classList.remove('hidden');
            });
        }

        function genPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("ASWA - LA RICA CHICHA", 10, 10);
            doc.text(`Cliente: ${document.getElementById('nom').value}`, 10, 20);
            doc.text(`Total: S/ ${calculate().toFixed(2)}`, 10, 30);
            doc.save("Aswa_Recibo.pdf");
        }

        function copyNum() { navigator.clipboard.writeText("947999736"); alert("N√∫mero copiado"); }
        function closeModal() { document.getElementById('modalSummary').style.display = 'none'; }
    </script>
</body>
</html>
