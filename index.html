<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Rica Chicha - ASWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places" type="text/javascript"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aswa-laricachicha';

        window.db = db;
        window.appId = appId;
        window.currentUser = null;

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.warn("Auth fallback:", err);
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
        });

        initAuth();

        window.saveOrder = async (orderData) => {
            if (!window.currentUser) return null;
            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'pedidos');
                const docRef = await addDoc(colRef, {
                    ...orderData,
                    fecha: serverTimestamp(),
                    uid: window.currentUser.uid,
                    compartido: false
                });
                return docRef.id;
            } catch (err) {
                console.error("Error guardando pedido:", err);
                return null;
            }
        };

        window.marcarComoCompartido = async (pedidoId) => {
            if (!pedidoId || !window.currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', pedidoId);
                await updateDoc(docRef, { compartido: true });
            } catch (err) {
                console.warn("No se pudo marcar como compartido:", err);
            }
        };

        window.listenOrders = (callback) => {
            if (!window.currentUser) return;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'pedidos');
            return onSnapshot(colRef, (snap) => {
                const orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                orders.sort((a, b) => (b.fecha?.seconds || 0) - (a.fecha?.seconds || 0));
                callback(orders);
            });
        };
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background:#0a0a0b; color:white; -webkit-tap-highlight-color:transparent; }
        .font-bebas { font-family: 'Bebas Neue', cursive; }
        .logo-container { width:70px; height:70px; background:#000; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(250,204,21,0.3); border:2px solid #facc15; cursor:pointer; overflow:hidden; position:relative; }
        .logo-container img { width:100%; height:100%; object-fit:cover; }
        .product-img-wrapper { width:80px; height:80px; border-radius:18px; border:1px solid #333; background:#1a1a1a; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; }
        .product-img-wrapper img { width:100%; height:100%; object-fit:cover; }
        .img-placeholder { color:#facc15; font-weight:800; font-size:1.3rem; text-align:center; line-height:1.2; }
        .app-card { background:linear-gradient(145deg,#18181b,#0f0f11); border:1px solid #27272a; transition:all .2s cubic-bezier(0.4,0,0.2,1); }
        .app-card:active { transform:scale(0.97); }
        .input-dark { background:#121214; border:1px solid #27272a; color:white; transition:border-color .3s; }
        .input-dark:focus { border-color:#facc15; outline:none; }
        .btn-order { background:linear-gradient(to right,#facc15,#eab308); box-shadow:0 10px 30px rgba(234,179,8,0.3); color:#000; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(10px); }
        .payment-option { border:2px solid #27272a; transition:all .2s; }
        .payment-option.active { border-color:#facc15 !important; background:rgba(250,204,21,0.15) !important; }
        #successMsg, #adminPanel { display:none; position:fixed; inset:0; background:#000; z-index:3000; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; }
        #adminPanel { z-index:1000; overflow-y:auto; }
        .copy-toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#facc15; color:black; padding:10px 24px; border-radius:30px; font-weight:bold; font-size:13px; display:none; z-index:4000; }
        .step-inactive { opacity:0.4; pointer-events:none; }
        .qr-image { width:240px; height:240px; object-fit:contain; border-radius:20px; border:4px solid white; }
        .social-share-btn { transition:all .3s; }
        .social-share-btn:active { transform:scale(0.9); }
    </style>
</head>
<body class="min-h-screen pb-48">

    <div id="copyToast" class="copy-toast">¬°N√∫mero copiado! ‚úì</div>

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full bg-black/80 backdrop-blur-md z-50 border-b border-zinc-900 px-6 py-4">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="logo-container" onclick="checkAdmin()">
                    <img src="logo de aswa.jpg" alt="Logo ASWA">
                </div>
                <div>
                    <h1 class="font-bebas text-3xl text-yellow-400 tracking-widest leading-none">La Rica Chicha</h1>
                    <p class="text-[10px] text-yellow-300/80 font-bold uppercase tracking-wider mt-1">el oro l√≠quido de la selva</p>
                </div>
            </div>
        </div>
    </header>

    <div class="h-32"></div>

    <main class="max-w-md mx-auto px-6 space-y-8">
        <!-- Bienvenida -->
        <div id="welcomeMsg" class="hidden">
            <div class="welcome-msg text-center">
                <p class="text-yellow-400 font-bold text-lg" id="welcomeText"></p>
            </div>
        </div>

        <!-- Packs -->
        <section>
            <h2 class="font-bold text-lg flex items-center gap-2 mb-5">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                Elige tu presentaci√≥n
            </h2>
            <div class="space-y-4">
                <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 p-5 rounded-3xl border border-zinc-700 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="product-img-wrapper">
                            <img src="aswa de 2 litros 1.png" alt="2L">
                        </div>
                        <div>
                            <p class="font-bold">Presentaci√≥n de 2 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 9.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-3 rounded-2xl">
                        <button type="button" onclick="updateQty('p2l',-1)" class="w-10 h-10 text-zinc-400">-</button>
                        <span id="qty-p2l" class="font-bold text-xl w-8 text-center">0</span>
                        <button type="button" onclick="updateQty('p2l',1)" class="w-10 h-10 bg-yellow-500 text-black rounded-xl">+</button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 p-5 rounded-3xl border border-zinc-700 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="product-img-wrapper">
                            <img src="aswa de 3 litros.png" alt="3L">
                        </div>
                        <div>
                            <p class="font-bold">Presentaci√≥n de 3 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 13.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-3 rounded-2xl">
                        <button type="button" onclick="updateQty('p3l',-1)" class="w-10 h-10 text-zinc-400">-</button>
                        <span id="qty-p3l" class="font-bold text-xl w-8 text-center">0</span>
                        <button type="button" onclick="updateQty('p3l',1)" class="w-10 h-10 bg-yellow-500 text-black rounded-xl">+</button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 p-5 rounded-3xl border border-yellow-500/30 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="product-img-wrapper border-yellow-500/30">
                            <img src="galon familiar de 4 litros.png" alt="4L">
                        </div>
                        <div>
                            <p class="font-bold">Presentaci√≥n de 4 litros</p>
                            <p class="text-yellow-400 font-bebas text-2xl">S/ 15.00</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-3 rounded-2xl">
                        <button type="button" onclick="updateQty('p4l',-1)" class="w-10 h-10 text-zinc-400">-</button>
                        <span id="qty-p4l" class="font-bold text-xl w-8 text-center">0</span>
                        <button type="button" onclick="updateQty('p4l',1)" class="w-10 h-10 bg-yellow-500 text-black rounded-xl">+</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Datos de entrega -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2 mb-4">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                Datos de entrega
            </h2>
            <input type="text" id="nombre" placeholder="Nombre completo" required class="w-full p-4 rounded-2xl input-dark text-sm">
            <div class="grid grid-cols-2 gap-3">
                <input type="tel" id="telefono" placeholder="Celular (9 d√≠gitos)" maxlength="9" required class="w-full p-4 rounded-2xl input-dark text-sm">
                <select id="distrito" onchange="calculateTotal()" required class="w-full p-4 rounded-2xl input-dark bg-[#121214] text-sm">
                    <option value="" disabled selected>Zona...</option>
                    <option value="3">Morales (S/3)</option>
                    <option value="4">Tarapoto (S/4)</option>
                    <option value="5">Banda de Shilcayo (S/5)</option>
                    <option value="0">Recojo en local (S/0)</option>
                </select>
            </div>

            <div>
                <textarea id="direccion" rows="3" placeholder="Direcci√≥n exacta + referencia" required class="w-full p-4 rounded-2xl input-dark text-sm"></textarea>

                <button type="button" onclick="obtenerUbicacionActual()" class="location-btn w-full mt-3 py-4 rounded-2xl flex items-center justify-center gap-3 shadow-lg">
                    <i data-lucide="navigation" class="w-6 h-6"></i>
                    COMPARTIR MI UBICACI√ìN ACTUAL
                </button>

                <div id="addressSuggestion" class="hidden mt-4">
                    <div class="address-suggestion text-center">
                        <p class="text-sm text-zinc-400 mb-3">Tu √∫ltima direcci√≥n fue:</p>
                        <p class="font-bold text-yellow-400 mb-3" id="lastAddressText"></p>
                        <div class="flex gap-3 justify-center">
                            <button type="button" onclick="usarDireccionAnterior()" class="px-6 py-3 bg-yellow-500 text-black font-black rounded-2xl">
                                Usar esta
                            </button>
                            <button type="button" onclick="cambiarDireccion()" class="px-6 py-3 bg-zinc-800 text-white font-bold rounded-2xl">
                                Cambiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- M√©todo de pago -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2 mb-4">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span>
                M√©todo de pago
            </h2>
            <div class="grid grid-cols-3 gap-3">
                <button type="button" onclick="setPayment('Efectivo')" id="btn-efectivo" class="payment-option bg-zinc-900 flex flex-col items-center gap-2 active">
                    <i data-lucide="banknote" class="w-10 h-10 text-green-500"></i>
                    <span class="text-xs font-bold">Efectivo</span>
                </button>
                <button type="button" onclick="setPayment('Yape')" id="btn-yape" class="payment-option bg-zinc-900 flex flex-col items-center gap-2">
                    <div class="w-10 h-10 bg-purple-600 rounded flex items-center justify-center text-white text-2xl font-black">Y</div>
                    <span class="text-xs font-bold">Yape</span>
                </button>
                <button type="button" onclick="setPayment('Plin')" id="btn-plin" class="payment-option bg-zinc-900 flex flex-col items-center gap-2">
                    <div class="w-10 h-10 bg-cyan-500 rounded flex items-center justify-center text-white text-2xl font-black">P</div>
                    <span class="text-xs font-bold">Plin</span>
                </button>
            </div>
        </section>

        <!-- Vis√≠tanos -->
        <div class="flex flex-col items-center gap-4 py-8 opacity-70">
            <p class="text-[10px] uppercase font-black tracking-[0.6em] text-yellow-500/80 text-center px-8">
                Sabor que une a la familia
            </p>
            <a href="https://www.google.com/maps/search/?api=1&query=ASWA+Tarapoto" target="_blank"
               class="flex items-center gap-3 px-6 py-4 rounded-2xl bg-zinc-900/70 border border-zinc-800 w-full max-w-xs">
                <i data-lucide="map-pin" class="text-yellow-500 w-6 h-6"></i>
                <div class="text-left">
                    <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">Vis√≠tanos en nuestro local</p>
                    <p class="text-sm font-bold text-white">Ver en Google Maps</p>
                </div>
                <i data-lucide="external-link" class="text-zinc-500 w-4 h-4 ml-auto"></i>
            </a>
        </div>
    </main>

    <!-- Footer -->
    <div class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-2xl border-t border-zinc-900 p-6 z-50">
        <div class="max-w-md mx-auto text-center">
            <p id="precioNormalMsg" class="text-zinc-400 text-sm mb-1"></p>
            <p id="descuentoMotivoMsg" class="text-green-400 font-bold mb-2 hidden"></p>
            <div class="flex items-center justify-between mt-3">
                <div>
                    <p class="text-xs text-zinc-500 uppercase font-bold">Total a pagar</p>
                    <p class="text-4xl font-bebas text-yellow-500" id="total-price">S/ 0.00</p>
                </div>
                <button onclick="prepararResumen()" class="bg-yellow-500 text-black px-8 py-5 rounded-3xl font-black text-xl shadow-2xl">
                    CONTINUAR <i data-lucide="arrow-right" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Resumen -->
    <div id="paymentModal" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-3xl p-8 border border-zinc-800 shadow-2xl">
            <h3 class="font-bebas text-3xl text-yellow-500 text-center mb-6">RESUMEN DE PEDIDO</h3>
            <div class="bg-black/50 rounded-2xl p-4 mb-6 border border-zinc-800">
                <div id="receipt-items" class="text-sm space-y-2"></div>
                <div class="border-t border-zinc-700 pt-3 mt-3">
                    <div class="flex justify-between text-yellow-400 font-bold">
                        <span>TOTAL:</span>
                        <span id="receipt-total">S/ 0.00</span>
                    </div>
                </div>
            </div>

            <div id="digital-payment-info" class="hidden text-center space-y-6">
                <p class="text-sm text-zinc-400 mb-3">1. Copia el n√∫mero y paga</p>
                <button onclick="copiarNumero()" class="w-full py-4 rounded-2xl bg-zinc-800 text-white font-bold text-sm flex items-center justify-center gap-2">
                    <i data-lucide="copy" class="w-5 h-5"></i> 947999736
                </button>

                <div class="bg-white p-4 rounded-3xl inline-block shadow-2xl">
                    <img src="yape del negocio.jpg" alt="QR ASWA" class="qr-image">
                </div>

                <p class="text-sm text-zinc-400 mb-3">2. Confirma que ya pagaste</p>
                <button id="btn-confirm-payment" onclick="confirmarPagoRealizado()" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 border border-yellow-500/40 font-black text-sm">
                    ¬°YA REALIC√â EL PAGO!
                </button>
            </div>

            <div id="cash-payment-info" class="hidden text-center py-8">
                <i data-lucide="truck" class="w-16 h-16 text-zinc-500 mx-auto mb-4"></i>
                <p class="text-zinc-300 text-lg">Pagar√°s en efectivo al recibir</p>
            </div>

            <div class="mt-8 pt-6 border-t border-zinc-800">
                <button id="btn-enviar-final" onclick="enviarPedidoFinal()" class="w-full bg-yellow-500 text-black py-4 rounded-2xl font-black text-lg mt-6 step-inactive">
                    ENVIAR PEDIDO <i data-lucide="send" class="w-5 h-5 ml-2"></i>
                </button>
                <p id="txt-wait" class="text-[10px] text-zinc-500 text-center mt-3">‚ö†Ô∏è Debes confirmar el pago digital arriba</p>
            </div>

            <button onclick="closeModal()" class="w-full text-zinc-500 text-xs mt-6 font-bold uppercase tracking-wider">
                Volver atr√°s
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const cart = { p2l: 0, p3l: 0, p4l: 0 };
        let currentMethod = 'Efectivo';
        let paymentConfirmed = false;
        let logoClicks = 0;
        let adminUnsubscribe = null;
        let ultimoPedidoId = "";
        let totalOriginal = 0;
        let totalConDescuento = 0;
        let porcentajeDescuento = 0;
        let motivoDescuento = "";
        let ubicacionActual = null;
        let ultimaDireccionCliente = "";

        function updateQty(prod, delta) {
            const nuevo = cart[prod] + delta;
            if (nuevo >= 0) {
                cart[prod] = nuevo;
                document.getElementById(`qty-${prod}`).textContent = nuevo;
                calculateTotal();
            }
        }

        function setPayment(met) {
            currentMethod = met;
            document.getElementById('btn-efectivo').classList.toggle('active', met === 'Efectivo');
            document.getElementById('btn-yape').classList.toggle('active', met === 'Yape');
            document.getElementById('btn-plin').classList.toggle('active', met === 'Plin');
        }

        async function calculateTotal() {
            const sub = cart.p2l * 9 + cart.p3l * 13 + cart.p4l * 15;
            const del = parseFloat(document.getElementById('distrito').value) || 0;
            totalOriginal = sub + del;

            document.getElementById('precioNormalMsg').textContent = totalOriginal > 0 ? `Precio normal: S/ ${totalOriginal.toFixed(2)}` : '';

            const tel = document.getElementById('telefono').value.trim();
            porcentajeDescuento = 0;
            motivoDescuento = "";

            if (tel.length === 9 && /^\d+$/.test(tel)) {
                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'pedidos'), where('telefono', '==', tel));
                    const snap = await getDocs(q);
                    const pedidos = snap.docs.map(doc => doc.data());

                    const compras = pedidos.length;
                    const compartidos = pedidos.filter(p => p.compartido).length;

                    if (compras >= 10) {
                        porcentajeDescuento = 0.15;
                        motivoDescuento = "15% por ser cliente VIP (10+ pedidos)";
                    } else if (compras >= 5) {
                        porcentajeDescuento = 0.10;
                        motivoDescuento = "10% por fidelidad (5+ pedidos)";
                    }

                    if (compartidos >= 3) {
                        porcentajeDescuento += 0.05;
                        if (motivoDescuento) motivoDescuento += " + ";
                        motivoDescuento += "5% extra por compartir";
                    }
                } catch (err) {
                    console.warn("Error calculando descuento:", err);
                }
            }

            totalConDescuento = totalOriginal * (1 - porcentajeDescuento);

            document.getElementById('total-price').textContent = totalConDescuento.toFixed(2) === totalOriginal.toFixed(2) 
                ? `S/ ${totalConDescuento.toFixed(2)}`
                : `S/ ${totalConDescuento.toFixed(2)}`;

            if (porcentajeDescuento > 0) {
                document.getElementById('descuentoMotivoMsg').textContent = motivoDescuento;
                document.getElementById('descuentoMotivoMsg').classList.remove('hidden');
            } else {
                document.getElementById('descuentoMotivoMsg').classList.add('hidden');
            }
        }

        function prepararResumen() {
            const sub = cart.p2l * 9 + cart.p3l * 13 + cart.p4l * 15;
            if (sub === 0) {
                alert("Elige al menos un pack");
                return;
            }

            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const zona = document.getElementById('distrito').value;

            if (!nombre || !telefono || !direccion || zona === "") {
                alert("Completa todos tus datos");
                return;
            }

            const rec = document.getElementById('receipt-items');
            rec.innerHTML = '';
            if (cart.p2l) rec.innerHTML += `<div class="flex justify-between"><span>Presentaci√≥n de 2 litros √ó${cart.p2l}</span><span>S/ ${(cart.p2l*9).toFixed(2)}</span></div>`;
            if (cart.p3l) rec.innerHTML += `<div class="flex justify-between"><span>Presentaci√≥n de 3 litros √ó${cart.p3l}</span><span>S/ ${(cart.p3l*13).toFixed(2)}</span></div>`;
            if (cart.p4l) rec.innerHTML += `<div class="flex justify-between"><span>Presentaci√≥n de 4 litros √ó${cart.p4l}</span><span>S/ ${(cart.p4l*15).toFixed(2)}</span></div>`;
            rec.innerHTML += `<div class="flex justify-between text-zinc-500"><span>Env√≠o</span><span>S/ ${(parseFloat(zona) || 0).toFixed(2)}</span></div>`;

            document.getElementById('receipt-total').textContent = `S/ ${totalConDescuento.toFixed(2)}`;

            if (currentMethod === 'Efectivo') {
                document.getElementById('digital-payment-info').classList.add('hidden');
                document.getElementById('cash-payment-info').classList.remove('hidden');
                document.getElementById('btn-enviar-final').classList.remove('step-inactive');
                document.getElementById('txt-wait').classList.add('hidden');
            } else {
                document.getElementById('digital-payment-info').classList.remove('hidden');
                document.getElementById('cash-payment-info').classList.add('hidden');
                document.getElementById('btn-enviar-final').classList.add('step-inactive');
                document.getElementById('txt-wait').classList.remove('hidden');
            }

            document.getElementById('paymentModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function confirmarPagoRealizado() {
            paymentConfirmed = true;
            const btn = document.getElementById('btn-confirm-payment');
            btn.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> PAGO CONFIRMADO';
            btn.classList.add('bg-green-600/20', 'text-green-400', 'border-green-400/40');
            btn.classList.remove('bg-zinc-800', 'text-yellow-500', 'border-yellow-500/40');
            btn.disabled = true;

            document.getElementById('btn-enviar-final').classList.remove('step-inactive');
            document.getElementById('txt-wait').classList.add('hidden');
            lucide.createIcons();
        }

        async function enviarPedidoFinal() {
            if (currentMethod !== 'Efectivo' && !paymentConfirmed) {
                alert("Confirma que ya realizaste el pago digital");
                return;
            }

            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const zona = document.getElementById('distrito').options[document.getElementById('distrito').selectedIndex].text;

            const itemsStr = `${cart.p2l ? `‚Ä¢ 2L: ${cart.p2l}\n` : ''}${cart.p3l ? `‚Ä¢ 3L: ${cart.p3l}\n` : ''}${cart.p4l ? `‚Ä¢ 4L: ${cart.p4l}\n` : ''}`;

            const pedidoId = await window.saveOrder({
                nombre, telefono, direccion, distrito: zona,
                items: cart, total: totalConDescuento, pago: currentMethod, confirmado: paymentConfirmed
            });

            if (!pedidoId) {
                alert("Error al guardar el pedido. Intenta de nuevo.");
                return;
            }

            closeModal();
            document.getElementById('successMsg').classList.remove('hidden');
            lucide.createIcons();

            const notaCaptura = currentMethod !== 'Efectivo' ? "üì∏ *POR FAVOR ADJUNTA LA CAPTURA AQU√ç*%0A%0A" : "";
            const pagoMsg = currentMethod === 'Efectivo' ? "Efectivo (contra entrega)" : `Pago v√≠a ${currentMethod} ‚úÖ`;

            const msg = `${notaCaptura}üåΩ *PEDIDO ASWA*%0A%0Aüë§ *Cliente:* ${nombre}%0Aüì± *Cel:* ${telefono}%0Aüìç *Zona:* ${zona}%0Aüè† *Direcci√≥n:* ${encodeURIComponent(direccion)}%0A%0Aüõí *Detalle:*%0A${encodeURIComponent(itemsStr)}%0Aüí≥ *Pago:* ${pagoMsg}%0Aüí∞ *Total:* S/ ${totalConDescuento.toFixed(2)}%0A%0AGracias ‚ù§Ô∏è`;

            setTimeout(() => {
                window.open(`https://wa.me/51986445531?text=${msg}`, '_blank');
                setTimeout(() => {
                    window.open(`https://wa.me/51955273229?text=${msg}`, '_blank');
                }, 800);
            }, 1500);
        }

        function copiarNumero() {
            navigator.clipboard.writeText("947999736");
            document.getElementById('copyToast').style.display = 'block';
            setTimeout(() => document.getElementById('copyToast').style.display = 'none', 2000);
        }

        function compartirEnFacebook() {
            const text = "¬°Acabo de pedir mi rica ASWA! üåΩ La mejor chicha de Tarapoto. @aswa.laricachicha";
            window.open(`https://www.facebook.com/sharer/sharer.php?quote=${encodeURIComponent(text)}`, '_blank');
        }

        function compartirEnInstagram() {
            const text = "¬°Acabo de pedir mi rica ASWA! üåΩ La mejor chicha de Tarapoto. @aswa.laricachicha";
            navigator.clipboard.writeText(text);
            alert("Texto copiado! P√©galo en Instagram y etiqu√©tanos para tu descuento ‚ù§Ô∏è");
        }

        function cerrarSuccessYReiniciar() {
            document.getElementById('successMsg').classList.add('hidden');
            cart.p2l = cart.p3l = cart.p4l = 0;
            document.querySelectorAll('[id^="qty-"]').forEach(el => el.textContent = '0');
            document.getElementById('orderForm').reset();
            document.getElementById('distrito').value = '';
            calculateTotal();
            currentMethod = 'Efectivo';
            setPayment('Efectivo');
            paymentConfirmed = false;
        }

        function checkAdmin() {
            logoClicks++;
            if (logoClicks >= 5) {
                document.getElementById('adminPanel').classList.remove('hidden');
                logoClicks = 0;
            }
            setTimeout(() => logoClicks = 0, 4000);
        }

        // Inicializar
        setPayment('Efectivo');
    </script>
</body>
</html>
