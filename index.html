<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Rica Chicha - ASWA (Oficial)</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUh_E02w4yEchGSAwoHzInDD7AluVVaSs",
            authDomain: "artifact-storage-demo.firebaseapp.com",
            projectId: "artifact-storage-demo",
            storageBucket: "artifact-storage-demo.firebasestorage.app",
            appId: "1:318890758945:web:7c364d983494e8b7db24c6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'aswa-laricachicha';

        window.db = db;
        window.appId = appId;
        window.query = query;
        window.collection = collection;
        window.where = where;
        window.getDocs = getDocs;
        window.onSnapshot = onSnapshot;

        signInAnonymously(auth);

        window.saveOrder = async (data) => {
            try {
                const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pedidos'), {
                    ...data, fecha: serverTimestamp(), estado: 'Pendiente', confirmado_cliente: false, compartido: false
                });
                return ref.id;
            } catch (e) { return "error-local"; }
        };

        window.marcarEntregadoCliente = async (id) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', id), { confirmado_cliente: true });
        };
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background:#0a0a0b; color:white; -webkit-tap-highlight-color:transparent; }
        .font-bebas { font-family: 'Bebas Neue', cursive; }
        .logo-container { width:90px; height:90px; background:#000; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 30px rgba(250,204,21,0.4); border:3px solid #facc15; overflow:hidden; cursor:pointer; }
        .app-card { background: #121214; border: 1px solid #27272a; border-radius: 2rem; }
        .input-dark { background:#121214; border:1px solid #27272a; color:white; border-radius: 1.2rem; padding: 1rem; width: 100%; transition: 0.3s; }
        .input-dark:focus { border-color: #facc15; outline:none; }
        .payment-option { border:2px solid #27272a; transition: 0.2s; cursor:pointer; border-radius: 1.5rem; }
        .payment-option.active { border-color:#facc15 !important; background:rgba(250,204,21,0.1) !important; transform: scale(1.05); }
        .btn-main { background: #facc15; color: black; font-weight: 900; border-radius: 1.5rem; transition: 0.2s; }
        .btn-main:disabled { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(10px); }
        .toast { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:#facc15; color:black; padding:10px 25px; border-radius:30px; font-weight:bold; display:none; z-index:4000; font-size: 12px; }
        .pac-container { background: #121214; border: 1px solid #333; color: white; border-radius: 1rem; }
        .pac-item { color: white; border-top: 1px solid #222; }
        .pac-item:hover { background: #222; }
        .pac-item-query { color: #facc15; }
    </style>
</head>
<body class="min-h-screen pb-44">

    <div id="copyToast" class="toast">¬°N√∫mero copiado! ‚úì</div>

    <!-- Header -->
    <header class="fixed top-0 left-0 w-full bg-black/80 backdrop-blur-md z-50 border-b border-zinc-900 p-4">
        <div class="max-w-md mx-auto flex items-center gap-4">
            <div class="logo-container" onclick="adminTrigger()">
                <img src="logo de aswa.jpg" alt="Logo ASWA" onerror="this.style.display='none'">
            </div>
            <div>
                <h1 class="font-bebas text-4xl text-yellow-400 tracking-widest leading-none">La Rica Chicha</h1>
                <p class="text-[9px] text-yellow-300/60 font-bold uppercase tracking-[0.4em] mt-1">el oro l√≠quido de la selva</p>
            </div>
        </div>
    </header>

    <div class="h-36"></div>

    <main class="max-w-md mx-auto px-6 space-y-8">
        
        <!-- Area Fidelidad -->
        <div id="loyaltyArea" class="hidden animate-pulse">
            <div class="bg-yellow-500/10 border border-yellow-500/50 p-4 rounded-3xl text-center">
                <p id="loyaltyText" class="text-yellow-400 font-bold text-sm"></p>
            </div>
        </div>

        <!-- Presentaciones -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> Selecciona Presentaci√≥n
            </h2>
            <div class="space-y-3">
                <div class="app-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="aswa de 2 litros 1.png" class="w-16" alt="2L">
                        <div><p class="font-bold text-sm">Presentaci√≥n 2L</p><p class="text-yellow-400 font-bebas text-2xl">S/ 9.00</p></div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-2 rounded-2xl">
                        <button onclick="updateQty('p2l', -1)" class="w-8 h-8 font-bold">-</button>
                        <span id="qty-p2l" class="font-bold text-xl w-4 text-center">0</span>
                        <button onclick="updateQty('p2l', 1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>
                <div class="app-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="aswa de 3 litros.png" class="w-16" alt="3L">
                        <div><p class="font-bold text-sm">Presentaci√≥n 3L</p><p class="text-yellow-400 font-bebas text-2xl">S/ 13.00</p></div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-2 rounded-2xl">
                        <button onclick="updateQty('p3l', -1)" class="w-8 h-8 font-bold">-</button>
                        <span id="qty-p3l" class="font-bold text-xl w-4 text-center">0</span>
                        <button onclick="updateQty('p3l', 1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>
                <div class="app-card p-4 flex items-center justify-between border-yellow-500/20">
                    <div class="flex items-center gap-3">
                        <img src="galon familiar de 4 litros.png" class="w-16" alt="4L">
                        <div><p class="font-bold text-sm">Familiar 4L</p><p class="text-yellow-400 font-bebas text-2xl">S/ 15.00</p></div>
                    </div>
                    <div class="flex items-center gap-4 bg-black/50 p-2 rounded-2xl">
                        <button onclick="updateQty('p4l', -1)" class="w-8 h-8 font-bold">-</button>
                        <span id="qty-p4l" class="font-bold text-xl w-4 text-center">0</span>
                        <button onclick="updateQty('p4l', 1)" class="w-8 h-8 bg-yellow-500 text-black rounded-xl font-bold">+</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Datos -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> Entrega
            </h2>
            <div class="space-y-3">
                <input type="tel" id="telefono" placeholder="Celular" maxlength="9" class="input-dark font-bold text-yellow-400">
                <input type="text" id="nombre" placeholder="Nombre completo" class="input-dark">
                <select id="distrito" onchange="calculateTotal()" class="input-dark">
                    <option value="" disabled selected>Zona de reparto...</option>
                    <option value="3">Morales (S/3)</option>
                    <option value="4">Tarapoto (S/4)</option>
                    <option value="5">Banda de Shilcayo (S/5)</option>
                    <option value="0">Recojo en local (S/0)</option>
                </select>
                <div>
                    <input type="text" id="direccion" placeholder="Direcci√≥n (Google Maps)" class="input-dark">
                    <p class="text-[10px] text-zinc-500 mt-2 ml-2">¬øNo aparece tu direcci√≥n? Puedes escribirla manualmente.</p>
                </div>
                <button onclick="obtenerGPS()" id="gpsBtn" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 font-bold text-xs flex gap-2 justify-center items-center">
                    <i data-lucide="map-pin" class="w-4 h-4"></i> COMPARTIR UBICACI√ìN GPS
                </button>
            </div>
        </section>

        <!-- Pago -->
        <section class="space-y-4">
            <h2 class="font-bold text-lg flex items-center gap-2">
                <span class="w-1.5 h-6 bg-yellow-500 rounded-full"></span> M√©todo de pago
            </h2>
            <div class="grid grid-cols-3 gap-3">
                <div onclick="setPayment('Efectivo')" id="pay-Efectivo" class="payment-option active p-4 flex flex-col items-center gap-2">
                    <i data-lucide="banknote" class="text-green-500"></i><span class="text-[10px] font-bold">Efectivo</span>
                </div>
                <div onclick="setPayment('Yape')" id="pay-Yape" class="payment-option p-4 flex flex-col items-center gap-2">
                    <div class="w-6 h-6 bg-purple-600 rounded flex items-center justify-center text-[10px] font-black italic">Y</div><span class="text-[10px] font-bold">Yape</span>
                </div>
                <div onclick="setPayment('Plin')" id="pay-Plin" class="payment-option p-4 flex flex-col items-center gap-2">
                    <div class="w-6 h-6 bg-cyan-500 rounded flex items-center justify-center text-[10px] font-black italic">P</div><span class="text-[10px] font-bold">Plin</span>
                </div>
            </div>

            <!-- Calculadora Vuelto -->
            <div id="vueltoArea" class="mt-4 p-4 app-card">
                <p class="text-[10px] font-bold text-zinc-500 mb-2 uppercase">Calculadora de Vuelto</p>
                <input type="number" id="pagoCon" placeholder="¬øCon cu√°nto pagar√°s?" oninput="calcVuelto()" class="input-dark mb-2">
                <p id="vueltoMsg" class="text-yellow-500 font-black">Vuelto sugerido: S/ 0.00</p>
            </div>
        </section>

        <!-- Frase y Local -->
        <div class="text-center py-6 space-y-6">
            <p class="text-[10px] uppercase font-black tracking-[0.4em] text-zinc-600 px-10">El sabor que une a nuestra familia tambi√©n est√°.</p>
            <a href="https://maps.google.com/?q=ASWA+Tarapoto" target="_blank" class="inline-flex items-center gap-2 text-xs font-bold text-yellow-500 border-b border-yellow-500/30 pb-1">
                <i data-lucide="map" class="w-4 h-4"></i> VIS√çTANOS EN NUESTRO LOCAL
            </a>
            <div class="flex justify-center gap-8 text-zinc-600 pt-4">
                <a href="https://facebook.com/aswa.laricachicha" target="_blank"><i data-lucide="facebook"></i></a>
                <a href="https://instagram.com/aswa.laricachicha" target="_blank"><i data-lucide="instagram"></i></a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-xl border-t border-zinc-800 p-6 z-[100]">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div>
                <p id="labelOld" class="text-[10px] text-zinc-500 line-through hidden"></p>
                <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">Total</p>
                <p id="totalPrice" class="text-4xl font-bebas text-yellow-500 tracking-wider">S/ 0.00</p>
            </div>
            <button onclick="abrirResumen()" class="btn-main px-10 py-5 text-lg flex items-center gap-2 shadow-xl shadow-yellow-500/10">
                CONTINUAR <i data-lucide="chevron-right"></i>
            </button>
        </div>
    </footer>

    <!-- Modal Resumen -->
    <div id="modalResumen" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-zinc-800 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="font-bebas text-3xl text-yellow-500 text-center mb-6">RESUMEN DEL PEDIDO</h3>
            <div id="listaResumen" class="space-y-2 text-sm text-zinc-400 mb-6 border-b border-zinc-800 pb-4"></div>
            
            <div id="zonaQR" class="hidden space-y-5 text-center">
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800">
                    <p class="text-[10px] text-zinc-500 uppercase font-bold mb-2">Pagar a: Telma Pezo Mel√©ndez</p>
                    <button onclick="copiarNumero()" class="text-xl font-black text-yellow-500 flex items-center justify-center gap-2 mx-auto">
                        947 999 736 <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
                <img src="yape del negocio.jpg" class="w-44 h-44 mx-auto rounded-3xl border-4 border-white shadow-2xl">
                <button onclick="validarPagoDigi()" id="btnVerificar" class="w-full py-4 rounded-2xl bg-zinc-800 text-yellow-500 text-xs font-black border border-yellow-500/20">YA REALIC√â EL PAGO</button>
            </div>

            <button id="btnFinal" onclick="finalizarEnvio()" disabled class="w-full mt-6 py-5 btn-main text-xl flex justify-center items-center gap-2">
                ENVIAR PEDIDO <i data-lucide="send"></i>
            </button>
            
            <button onclick="cerrarModal()" class="w-full mt-6 text-zinc-600 text-[10px] font-bold uppercase tracking-widest">Regresar</button>
        </div>
    </div>

    <!-- √âxito y Seguimiento -->
    <div id="successScreen" class="hidden fixed inset-0 bg-black z-[3000] flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
        <div class="w-20 h-20 bg-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-xl shadow-yellow-500/20">
            <i data-lucide="truck" class="text-black w-10 h-10"></i>
        </div>
        <h2 class="font-bebas text-5xl text-yellow-500 mb-2">¬°PEDIDO RECIBIDO!</h2>
        <p id="statusTxt" class="text-zinc-500 text-sm mb-10">Enviando detalles a cocina...</p>
        
        <!-- Confirmaci√≥n Final del Cliente -->
        <div id="clientArea" class="hidden w-full space-y-4 mb-10">
            <div class="p-4 bg-green-600/10 border-2 border-green-600 rounded-[2rem]">
                <p class="text-green-500 font-bold mb-4">¬øYa tienes tu ASWA contigo?</p>
                <button onclick="clienteConfirmaRecibo()" class="w-full py-5 bg-green-600 text-white rounded-[1.5rem] font-black shadow-lg">S√ç, YA RECIB√ç MI PEDIDO ‚úÖ</button>
            </div>
        </div>

        <div id="notaArea" class="hidden w-full mb-10">
            <button onclick="generarNotaVenta()" class="w-full py-5 bg-white text-black rounded-[1.5rem] font-black flex justify-center gap-2 shadow-xl">
                <i data-lucide="file-text"></i> DESCARGAR NOTA DE VENTA
            </button>
        </div>

        <button onclick="location.reload()" class="text-zinc-600 font-bold text-[10px] uppercase">Nuevo Pedido</button>
    </div>

    <script>
        lucide.createIcons();
        let st = { cart:{p2l:0, p3l:0, p4l:0}, pay:'Efectivo', disc:{p:0, m:''}, gps:'', id:'', raw:0, final:0, data:{} };

        // Autocomplete de Google Maps
        window.onload = () => {
            const input = document.getElementById('direccion');
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setComponentRestrictions({ 'country': ['pe'] });
        };

        function updateQty(id, delta) {
            st.cart[id] = Math.max(0, st.cart[id] + delta);
            document.getElementById(`qty-${id}`).innerText = st.cart[id];
            calculateTotal();
        }

        function setPayment(m) {
            st.pay = m;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`pay-${m}`).classList.add('active');
            document.getElementById('vueltoArea').style.display = (m === 'Efectivo') ? 'block' : 'none';
            calculateTotal();
        }

        function calcVuelto() {
            const paga = parseFloat(document.getElementById('pagoCon').value) || 0;
            const v = Math.max(0, paga - st.final);
            document.getElementById('vueltoMsg').innerText = `Vuelto sugerido: S/ ${v.toFixed(2)}`;
        }

        // B√∫squeda de Fidelidad (Debounce)
        let timer;
        document.getElementById('telefono').addEventListener('input', (e) => {
            clearTimeout(timer);
            if(e.target.value.length === 9) timer = setTimeout(() => searchCust(e.target.value), 500);
        });

        async function searchCust(tel) {
            const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'pedidos'), window.where('telefono', '==', tel));
            const snap = await window.getDocs(q);
            if(!snap.empty) {
                const list = snap.docs.map(d => d.data());
                const last = list.sort((a,b) => b.fecha?.seconds - a.fecha?.seconds)[0];
                document.getElementById('nombre').value = last.nombre;
                document.getElementById('direccion').value = last.direccion;
                
                let p = list.length >= 10 ? 0.15 : (list.length >= 5 ? 0.10 : 0);
                let m = list.length >= 10 ? "VIP (15%)" : (list.length >= 5 ? "Frecuente (10%)" : "");
                if(list.filter(x => x.compartido).length >= 3) { p += 0.05; m += " + Bono Social (5%)"; }
                
                st.disc = {p, m};
                document.getElementById('loyaltyText').innerText = `¬°Hola ${last.nombre.split(' ')[0]}! Tienes un descuento ${m}`;
                document.getElementById('loyaltyArea').classList.remove('hidden');
                calculateTotal();
            }
        }

        function calculateTotal() {
            const base = (st.cart.p2l*9) + (st.cart.p3l*13) + (st.cart.p4l*15);
            const deli = parseFloat(document.getElementById('distrito').value) || 0;
            st.raw = base + deli;
            st.final = st.raw * (1 - st.disc.p);
            document.getElementById('totalPrice').innerText = `S/ ${st.final.toFixed(2)}`;
            if(st.disc.p > 0) {
                document.getElementById('labelOld').innerText = `S/ ${st.raw.toFixed(2)}`;
                document.getElementById('labelOld').classList.remove('hidden');
            }
            return st.final;
        }

        function obtenerGPS() {
            const btn = document.getElementById('gpsBtn');
            btn.innerText = "LOCALIZANDO...";
            navigator.geolocation.getCurrentPosition(p => {
                st.gps = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                btn.innerText = "UBICACI√ìN LISTA ‚úÖ";
                btn.classList.replace('bg-zinc-800', 'bg-green-900');
            });
        }

        function abrirResumen() {
            const t = calculateTotal();
            if(t <= 0) return alert("Selecciona presentaciones");
            if(!document.getElementById('distrito').value) return alert("Selecciona zona");
            if(!document.getElementById('nombre').value || !document.getElementById('telefono').value) return alert("Faltan datos");

            const l = document.getElementById('listaResumen');
            l.innerHTML = "";
            if(st.cart.p2l) l.innerHTML += `<div class="flex justify-between"><span>Presentaci√≥n 2L x${st.cart.p2l}</span><span>S/ ${st.cart.p2l*9}</span></div>`;
            if(st.cart.p3l) l.innerHTML += `<div class="flex justify-between"><span>Presentaci√≥n 3L x${st.cart.p3l}</span><span>S/ ${st.cart.p3l*13}</span></div>`;
            if(st.cart.p4l) l.innerHTML += `<div class="flex justify-between"><span>Familiar 4L x${st.cart.p4l}</span><span>S/ ${st.cart.p4l*15}</span></div>`;
            l.innerHTML += `<div class="flex justify-between font-black text-yellow-500 pt-3 border-t border-zinc-800"><span>TOTAL FINAL</span><span>S/ ${t.toFixed(2)}</span></div>`;

            const btnFinal = document.getElementById('btnFinal');
            if(st.pay === 'Efectivo') {
                document.getElementById('zonaQR').classList.add('hidden');
                btnFinal.disabled = false;
            } else {
                document.getElementById('zonaQR').classList.remove('hidden');
                btnFinal.disabled = true;
            }
            document.getElementById('modalResumen').style.display = 'flex';
        }

        function validarPagoDigi() {
            document.getElementById('btnFinal').disabled = false;
            document.getElementById('btnVerificar').innerText = "¬°PAGO CONFIRMADO POR TI! ‚úÖ";
            document.getElementById('btnVerificar').classList.add('bg-green-600/20', 'text-green-500');
        }

        async function finalizarEnvio() {
            const btn = document.getElementById('btnFinal');
            btn.innerText = "PROCESANDO..."; btn.disabled = true;

            const pagaCon = parseFloat(document.getElementById('pagoCon').value) || st.final;
            st.data = {
                nombre: document.getElementById('nombre').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                distrito: document.getElementById('distrito').options[document.getElementById('distrito').selectedIndex].text,
                items: st.cart, total: st.final, pago: st.pay, gps: st.gps,
                vuelto: Math.max(0, pagaCon - st.final), paga_con: pagaCon
            };

            st.id = await window.saveOrder(st.data);
            
            const msg = `üåΩ *PEDIDO ASWA*\nüë§ *Cliente:* ${st.data.nombre}\nüì± *Cel:* ${st.data.telefono}\nüìç *Zona:* ${st.data.distrito}\nüè† *Dir:* ${st.data.direccion}\n${st.gps?'üåç *GPS:* '+st.gps+'\n':''}üí≥ *Pago:* ${st.pay}${st.pay==='Efectivo'?'\nüíµ *Paga con:* S/ '+pagaCon.toFixed(2)+'\nüí∞ *Vuelto:* S/ '+st.data.vuelto.toFixed(2):''}\nüí∞ *Total:* S/ ${st.final.toFixed(2)}`;

            // Dual WhatsApp
            window.open(`https://wa.me/51986445531?text=${encodeURIComponent(msg)}`, '_blank');
            setTimeout(() => {
                window.open(`https://wa.me/51955273229?text=${encodeURIComponent(msg)}`, '_blank');
                document.getElementById('modalResumen').style.display = 'none';
                document.getElementById('successScreen').classList.remove('hidden');
                lucide.createIcons();
                trackOrder();
            }, 1000);
        }

        function trackOrder() {
            window.onSnapshot(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'pedidos', st.id), (doc) => {
                const d = doc.data();
                document.getElementById('statusTxt').innerText = `Estado: ${d.estado}`;
                if(d.estado === 'Entregado' && !d.confirmado_cliente) {
                    document.getElementById('clientArea').classList.remove('hidden');
                }
                if(d.confirmado_cliente) {
                    document.getElementById('statusTxt').innerText = "¬°Pedido finalizado con √©xito!";
                    document.getElementById('clientArea').classList.add('hidden');
                    document.getElementById('notaArea').classList.remove('hidden');
                }
            });
        }

        async function clienteConfirmaRecibo() { await window.marcarEntregadoCliente(st.id); }

        function generarNotaVenta() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(22); doc.text("NOTA DE VENTA - ASWA", 105, 20, {align:"center"});
            doc.setFontSize(10);
            doc.text(`Cliente: ${st.data.nombre}`, 20, 40);
            doc.text(`Direcci√≥n: ${st.data.direccion}`, 20, 48);
            doc.text(`Celular: ${st.data.telefono}`, 20, 56);
            doc.text("--------------------------------------------------------------------------------", 20, 65);
            let y = 75;
            if(st.cart.p2l) { doc.text(`Presentaci√≥n 2L x${st.cart.p2l}`, 20, y); doc.text(`S/ ${(st.cart.p2l*9).toFixed(2)}`, 170, y); y+=10; }
            if(st.cart.p3l) { doc.text(`Presentaci√≥n 3L x${st.cart.p3l}`, 20, y); doc.text(`S/ ${(st.cart.p3l*13).toFixed(2)}`, 170, y); y+=10; }
            if(st.cart.p4l) { doc.text(`Familiar 4L x${st.cart.p4l}`, 20, y); doc.text(`S/ ${(st.cart.p4l*15).toFixed(2)}`, 170, y); y+=10; }
            doc.text("--------------------------------------------------------------------------------", 20, y); y+=10;
            doc.setFontSize(14); doc.text(`TOTAL PAGADO: S/ ${st.final.toFixed(2)}`, 20, y);
            doc.save(`Recibo_ASWA_${st.data.nombre}.pdf`);
        }

        function copiarNumero() {
            navigator.clipboard.writeText("947999736");
            const t = document.getElementById('copyToast');
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000);
        }

        function cerrarModal() { document.getElementById('modalResumen').style.display = 'none'; }
        function adminTrigger() { let c=0; return () => { c++; if(c>=5) alert("Panel Admin"); } }
        window.adminTrigger = adminTrigger();
    </script>
</body>
</html>
